<!DOCTYPE html>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        var verified_Phone = 0;

        function checkDuplicationNick() {
            var nickname = $('#inputNickname').val();
            if (!nickname) {
                $('#duplicationCheckNickResult').css("display", "none");
                return;
            }

            $.ajax({
                type: 'POST',
                url: '/checkDuplicationNick',
                data: {
                    nickname: nickname
                },
                success: function (response) {
                    if (response === 0) {
                        $('#duplicationCheckNickResult').removeClass("alert-danger")
                            .addClass("alert-success")
                            .css("display", "block")
                            .text('사용 가능한 닉네임입니다.');
                    } else {
                        $('#duplicationCheckNickResult').removeClass("alert-success")
                            .addClass("alert-danger")
                            .css("display", "block")
                            .text('이미 사용중인 닉네임입니다.');
                    }
                },
                error: function (request, status, error) {
                    console.log('AJAX Error: ' + error);
                }
            });
        }

        function sendPhone() {
            var phone = $("#inputPhone").val();

            $.ajax({
                type: "POST",
                url: "/send-one",
                data: {
                    phone: phone
                },
                success: function (data) {
                    $("#inputCertifiedNumber").css("display", "block");
                    $("#verify").css("display", "block");
                    alert("전송 성공");
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("전화번호를 다시 확인해주세요");
                    $("#inputPhone").focus();
                }
            });
        }

        function verifyCertifiedNumber() {
            var certifiedNumber = $("#inputCertifiedNumber").val();

            $.ajax({
                type: "POST",
                url: "/verify-certified-number",
                data: {
                    certifiedNumber: certifiedNumber
                },
                success: function (data) {
                    alert("인증 성공");
                    $("#inputPhone").prop('disabled', true);
                    $("#inputCertifiedNumber").prop('disabled', true);
                    $("#phone_verify_success").css("display", "block");
                    $("#verify").css("display", "none");
                    $("#submit-button").css("display", "block");
                    verified_Phone++;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("인증 실패: " + textStatus);
                }
            });
        }

        function checkSubmit() {
            if (verified_Phone === 1) {
                $("form").submit();
            } else {
                alert("휴대폰 인증을 해주세요.");
            }
        }

        function postDelete() {
            if (confirm("정말로 가입을 취소하시겠습니까?")) {
                var form = document.querySelector('form');
                form.setAttribute('action', '/delete');
                form.setAttribute('method', 'POST');
                form.submit();
            }
        }
    </script>

</head>
<body>
<form method="post" action="updateInfo">
    <div class="container">
        <h1>추가 정보 기입</h1>

        <input type="hidden" class="form-control" id="user_id" name="user_id" th:value="${user_id}">
        <div class="form-group">
            <label for="inputNickname">별 명</label>
            <input type="text" class="form-control" id="inputNickname" name="nickname" placeholder="사용자 별명"
                   onkeyup="checkDuplicationNick()" required="required">
            <span id="duplicationCheckNickResult" class="alert alert-danger" style="display: none"></span>
        </div>
        <div class="form-group">
            <label for="selectTelecom">통신사</label>
            <select class="form-control" id="selectTelecom" name="telecom" required="required">
                <option value="SKT">SKT</option>
                <option value="KT">KT</option>
                <option value="LG">LG</option>
                <option value="알뜰폰">알뜰폰</option>
            </select>
        </div>
        <div class="form-group">
            <label for="inputPhone">전화번호</label>
            <input type="tel" class="form-control" id="inputPhone" name="phone"
                   placeholder="사용자 전화번호 (01012345678) '-을 제외하고 입력해주세요.'" required="required">
            <button type="button" id="check" class="btn btn-secondary" onclick="sendPhone()">전화번호 인증</button>
        </div>
        <div class="form-group">
            <label for="inputCertifiedNumber" style="display:none;">인증번호</label>
            <input type="number" class="form-control" id="inputCertifiedNumber" name="certifiedNumber"
                   placeholder="인증번호를 입력하세요" required="required" style="display:none;">
            <button type="button" id="verify" class="btn btn-secondary" onclick="verifyCertifiedNumber()"
                    style="display:none;">인증번호 확인
            </button>
            <button type="button" disabled id="phone_verify_success" class="alert alert-success"
                    style="display: none;">인증되었습니다.
            </button>
        </div>
        <div class="form-group">
            <label for="selectGender">성별</label>
            <select class="form-control" id="selectGender" name="gender" required="required">
                <option value="male">남성</option>
                <option value="female">여성</option>
            </select>
        </div>
        <div class="form-group">
            <label for="selectAuth">회원 구분</label>
            <select class="form-control" id="selectAuth" name="auth_level" required="required">
                <option value="SELLER">SELLER</option>
                <option value="USER" selected>USER</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary" id="submit-button" style="display: block;" onclick="checkSubmit()">
            가입 완료
        </button>
        <button type="button" class="btn btn-danger" th:attr="onclick=${'javascript:postDelete()'}">가입 취소</button>
    </div>
</form>
</body>
</html>